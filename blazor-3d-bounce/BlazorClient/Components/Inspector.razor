@namespace BlazorClient.Components

<div class="inspector panel">
    <div class="panel-header">
        <span><i class="bi bi-sliders"></i></span>
        <span>Inspector</span>
    </div>

    @if (SelectedRigidBody != null)
    {
        <RigidBodyInspector Body="@SelectedRigidBody" 
                           OnBodyChanged="OnRigidBodyChangedInternal"
                           OnDelete="OnDeleteObjectInternal" />
    }
    else if (SelectedSoftBody != null)
    {
        <SoftBodyInspector Body="@SelectedSoftBody"
                          OnBodyChanged="OnSoftBodyChangedInternal"
                          OnDelete="OnDeleteObjectInternal" />
    }
    else
    {
        <div class="inspector-empty">
            <div class="inspector-empty-icon"><i class="bi bi-cursor"></i></div>
            <p class="text-muted">Select an object to inspect</p>
            <p class="text-muted" style="font-size: 0.75rem;">Click on an object in the viewport or object list</p>
        </div>
    }

    <hr style="border-color: var(--border-color); margin: 1rem 0;" />

    <!-- Global Settings -->
    <div class="panel-section">
        <div class="panel-section-title">Simulation</div>
        
        <div class="form-group">
            <label class="form-label">Gravity Y</label>
            <div class="range-slider">
                <input type="range" min="-20" max="0" step="0.1" 
                       value="@SimulationSettings.Gravity.Y"
                       @oninput="OnGravityChange" />
                <span class="range-value">@SimulationSettings.Gravity.Y.ToString("F1")</span>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Time Scale</label>
            <div class="range-slider">
                <input type="range" min="0" max="2" step="0.1"
                       value="@SimulationSettings.TimeScale"
                       @oninput="OnTimeScaleChange" />
                <span class="range-value">@SimulationSettings.TimeScale.ToString("F1")x</span>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Sub-steps</label>
            <div class="range-slider">
                <input type="range" min="1" max="8" step="1"
                       value="@SimulationSettings.SubSteps"
                       @oninput="OnSubStepsChange" />
                <span class="range-value">@SimulationSettings.SubSteps</span>
            </div>
        </div>
    </div>

    <div class="panel-section">
        <div class="panel-section-title">Rendering</div>
        
        <div class="form-group">
            <label class="checkbox-group">
                <input type="checkbox" checked="@RenderSettings.EnableShadows" 
                       @onchange="e => OnRenderSettingToggle(nameof(RenderSettings.EnableShadows), (bool)(e.Value ?? false))" />
                <span>Shadows</span>
            </label>
        </div>

        <div class="form-group">
            <label class="checkbox-group">
                <input type="checkbox" checked="@RenderSettings.ShowGrid"
                       @onchange="e => OnRenderSettingToggle(nameof(RenderSettings.ShowGrid), (bool)(e.Value ?? false))" />
                <span>Grid</span>
            </label>
        </div>

        <div class="form-group">
            <label class="checkbox-group">
                <input type="checkbox" checked="@RenderSettings.ShowAxes"
                       @onchange="e => OnRenderSettingToggle(nameof(RenderSettings.ShowAxes), (bool)(e.Value ?? false))" />
                <span>Axes</span>
            </label>
        </div>

        <div class="form-group">
            <label class="checkbox-group">
                <input type="checkbox" checked="@RenderSettings.ShowWireframe"
                       @onchange="e => OnRenderSettingToggle(nameof(RenderSettings.ShowWireframe), (bool)(e.Value ?? false))" />
                <span>Wireframe</span>
            </label>
        </div>

        <div class="form-group">
            <label class="checkbox-group">
                <input type="checkbox" checked="@RenderSettings.EnableFXAA"
                       @onchange="e => OnRenderSettingToggle(nameof(RenderSettings.EnableFXAA), (bool)(e.Value ?? false))" />
                <span>FXAA</span>
            </label>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public RigidBody? SelectedRigidBody { get; set; }

    [Parameter]
    public SoftBody? SelectedSoftBody { get; set; }

    [Parameter]
    public SimulationSettings SimulationSettings { get; set; } = new();

    [Parameter]
    public RenderSettings RenderSettings { get; set; } = new();

    [Parameter]
    public EventCallback<RigidBody> OnRigidBodyChanged { get; set; }

    [Parameter]
    public EventCallback<SoftBody> OnSoftBodyChanged { get; set; }

    [Parameter]
    public EventCallback<SimulationSettings> OnSettingsChanged { get; set; }

    [Parameter]
    public EventCallback<RenderSettings> OnRenderSettingsChanged { get; set; }

    [Parameter]
    public EventCallback OnDeleteObject { get; set; }

    private async Task OnRigidBodyChangedInternal(RigidBody body)
    {
        await OnRigidBodyChanged.InvokeAsync(body);
    }

    private async Task OnSoftBodyChangedInternal(SoftBody body)
    {
        await OnSoftBodyChanged.InvokeAsync(body);
    }

    private async Task OnDeleteObjectInternal()
    {
        await OnDeleteObject.InvokeAsync();
    }

    private async Task OnGravityChange(ChangeEventArgs e)
    {
        if (float.TryParse(e.Value?.ToString(), out var value))
        {
            SimulationSettings.Gravity = new Vector3(0, value, 0);
            await OnSettingsChanged.InvokeAsync(SimulationSettings);
        }
    }

    private async Task OnTimeScaleChange(ChangeEventArgs e)
    {
        if (float.TryParse(e.Value?.ToString(), out var value))
        {
            SimulationSettings.TimeScale = value;
            await OnSettingsChanged.InvokeAsync(SimulationSettings);
        }
    }

    private async Task OnSubStepsChange(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var value))
        {
            SimulationSettings.SubSteps = value;
            await OnSettingsChanged.InvokeAsync(SimulationSettings);
        }
    }

    private async Task OnRenderSettingToggle(string property, bool value)
    {
        switch (property)
        {
            case nameof(RenderSettings.EnableShadows):
                RenderSettings.EnableShadows = value;
                break;
            case nameof(RenderSettings.ShowGrid):
                RenderSettings.ShowGrid = value;
                break;
            case nameof(RenderSettings.ShowAxes):
                RenderSettings.ShowAxes = value;
                break;
            case nameof(RenderSettings.ShowWireframe):
                RenderSettings.ShowWireframe = value;
                break;
            case nameof(RenderSettings.EnableFXAA):
                RenderSettings.EnableFXAA = value;
                break;
        }
        await OnRenderSettingsChanged.InvokeAsync(RenderSettings);
    }
}
